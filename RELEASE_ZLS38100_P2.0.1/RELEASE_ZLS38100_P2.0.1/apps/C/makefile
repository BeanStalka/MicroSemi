SHELL := /bin/bash
export ROOTDIR ?= $(PWD)/../..

## Sample apps for Microsemi VPROC Devices Host Bus Interface
## Current Makefile compiles app using user-space driver for linux
## platform.
## user can modify OBJS variable to point to platform independent ## HBI driver for non-linux platform

## These should always be included as defines Driver configuration
## parameter
include $(ROOTDIR)/Makefile.globals
include $(ROOTDIR)/config.mk
##for static boot loading please enable LOAD_FWR_STATIC and set FWR to filename to be included for static compilation
#LOAD_FWR_STATIC = 1
##this file is generated by running firmware image convertor tool which converts an s3 image to .h/.c or .bin file
#FWR = zls38067_0_firmware.h
#LOAD_CFGREC_STATIC = 1
#CFGREC = zls38067_0_config.h
##TOOLCHAIN path for userspace build. 
##Uncomment if doing cross compilation and set to path containing toolchain
#SYSROOT=$(TOOLSPATH)/arm-linux-gnueabihf/libc

##link to hbi user space driver for linux platform
##user can modify OBJS to link platform independent 
##hbi driver objs
OBJS = $(INSTALL_LIB_PATH)/hbi_u.o $(INSTALL_LIB_PATH)/hbi_tw.o

SRC = 
##default TARGET built is hbi_test
ifneq ($(HBI_TEST),)
APPS = hbi_test
endif

INCLUDES += -I$(ROOTDIR)/drivers/hbi/inc 
INCLUDES += -I$(ROOTDIR)/apps/C/utils 
INCLUDES += -I$(ROOTDIR)/apps/C

##uncomment is you have updated SYSROOT
#LDFLAGS += --sysroot=$(SYSROOT)

ifneq ($(DEBUG),)
LDFLAGS += -g
endif


ifneq ($(LOAD_FWR_STATIC),)
ifeq ($(FWR),)
$(error "please set FWR to firmware file for static compilation")
endif
LDFLAGS += -DLOAD_FWR_STATIC
LDFLAGS += -DFWR_C_FILE=$(FWR)
endif

ifneq ($(LOAD_CFGREC_STATIC),)
ifeq ($(CFGREC),)
$(error "please set CFGREC to configuration record file for static compilation")
endif
LDFLAGS += -DLOAD_CFGREC_STATIC
LDFLAGS += -DCFGREC_C_FILE=$(CFGREC)
endif

ifneq ($(HBI_LOAD_FIRMWARE),)
APPS += hbi_load_firmware
SRC = utils/app_util.c
endif

ifneq ($(HBI_LOAD_GRAMMAR),)
APPS += hbi_load_grammar
endif

.PHONY: $(APPS)
all: $(APPS)

$(APPS):
	$(CC)  $(OBJS) $(SRC) $@.c $(EXTRA_CFLAGS) $(INCLUDES) $(LDFLAGS) -o $@	

clean:
	rm -f *.out *.o

help:
	@echo "TEST MACROS:"
	@echo "HBI_LOAD_FIRMWARE - builds sample app to load firmware and configuration record to device. Sample app support both dynamic and static loading of images."
	@echo "HBI_LOAD_GRAMMAR - builds sample app to load ASR grammar to device. "
	@echo "To build static firmware, define LOAD_FWR_STATIC, and set FWR to filename included for compilation."
	@echo "To build configuration record, define LOAD_CFGREC_STATIC and set CFGREC to C-file of configuration  in apps/makefile"
		
